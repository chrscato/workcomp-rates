{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Transparency Dashboard - WorkComp Rates{% endblock %}

{% block extra_head %}
<!-- Select2 for enhanced dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    .filter-tier {
        margin-bottom: 2rem;
    }
    
    .filter-tier .card {
        border: 1px solid #e3f2fd;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        overflow: hidden;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    }
    
    .filter-tier .card-header {
        background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
        border-bottom: none;
        color: white;
        padding: 1.25rem;
    }
    
    .filter-tier-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 0;
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .partition-summary .card {
        border: 1px solid #e3f2fd;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
    }
    
    .summary-metric {
        text-align: center;
        padding: 1rem;
    }
    
    .summary-metric h3 {
        font-size: 2rem;
        font-weight: 700;
        color: #1976d2;
        margin-bottom: 0.5rem;
    }
    
    .summary-metric p {
        font-size: 0.9rem;
        color: #6c757d;
        margin: 0;
    }
    
    /* Enhanced Select2 Styling */
    .select2-container {
        width: 100% !important;
    }
    
    .select2-container--bootstrap-5 .select2-selection {
        border: 2px solid #e3f2fd;
        border-radius: 10px;
        background: white;
        transition: all 0.3s ease;
        min-height: 48px;
        padding: 8px 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .select2-container--bootstrap-5 .select2-selection:hover {
        border-color: #90caf9;
        box-shadow: 0 4px 8px rgba(25, 118, 210, 0.15);
    }
    
    .select2-container--bootstrap-5.select2-container--focus .select2-selection {
        border-color: #1976d2;
        box-shadow: 0 0 0 0.2rem rgba(25, 118, 210, 0.25);
        background: #fafafa;
    }
    
    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
        color: #333;
        line-height: 32px;
        font-weight: 500;
        padding-left: 0;
    }
    
    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__rendered {
        padding: 0;
    }
    
    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
        background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
        border: none;
        border-radius: 20px;
        color: white;
        padding: 4px 12px;
        margin: 2px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove {
        color: white;
        margin-right: 6px;
        font-weight: bold;
    }
    
    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove:hover {
        color: #ffcdd2;
    }
    
    .select2-dropdown {
        border: 2px solid #e3f2fd;
        border-radius: 10px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        background: white;
        overflow: hidden;
    }
    
    .select2-container--bootstrap-5 .select2-results__option {
        padding: 12px 16px;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        border-bottom: 1px solid #f5f5f5;
    }
    
    .select2-container--bootstrap-5 .select2-results__option--highlighted {
        background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
        color: white;
        font-weight: 500;
    }
    
    .select2-container--bootstrap-5 .select2-results__option--selected {
        background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
        color: white;
        font-weight: 600;
    }
    
    .select2-container--bootstrap-5 .select2-search--dropdown .select2-search__field {
        border: 2px solid #e3f2fd;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 0.95rem;
        margin: 8px;
        width: calc(100% - 16px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .select2-container--bootstrap-5 .select2-search--dropdown .select2-search__field:focus {
        border-color: #1976d2;
        box-shadow: 0 0 0 0.2rem rgba(25, 118, 210, 0.25);
        outline: none;
    }
    
    .form-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }
    
    .form-text {
        font-size: 0.85rem;
        margin-top: 6px;
        color: #666;
        font-style: italic;
    }
    
    .form-select.is-invalid {
        border-color: #f44336;
        box-shadow: 0 0 0 0.2rem rgba(244, 67, 54, 0.25);
    }
    
    /* Professional button styling */
    .btn-primary {
        background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        font-weight: 600;
        box-shadow: 0 4px 8px rgba(25, 118, 210, 0.3);
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
        box-shadow: 0 6px 12px rgba(25, 118, 210, 0.4);
        transform: translateY(-1px);
    }
    
    .btn-outline-secondary {
        border: 2px solid #e0e0e0;
        color: #666;
        border-radius: 8px;
        padding: 12px 24px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-outline-secondary:hover {
        border-color: #1976d2;
        color: #1976d2;
        background: rgba(25, 118, 210, 0.05);
    }
    
    /* Enhanced dropdown specific styling */
    .enhanced-dropdown {
        border-radius: 12px !important;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
    }
    
    .enhanced-dropdown .select2-results__option {
        padding: 14px 20px !important;
        font-size: 0.95rem !important;
        transition: all 0.2s ease !important;
        border-bottom: 1px solid #f0f0f0 !important;
    }
    
    .enhanced-dropdown .select2-results__option:hover {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
        color: #1976d2 !important;
        font-weight: 500 !important;
        transform: translateX(4px) !important;
    }
    
    .enhanced-dropdown .select2-results__option--highlighted {
        background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%) !important;
        color: white !important;
        font-weight: 600 !important;
        transform: translateX(4px) !important;
        box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3) !important;
    }
    
    .enhanced-dropdown .select2-search--dropdown {
        padding: 12px !important;
        background: #f8f9fa !important;
        border-bottom: 2px solid #e3f2fd !important;
    }
    
    .enhanced-dropdown .select2-search__field {
        font-size: 0.95rem !important;
        padding: 12px 16px !important;
        border-radius: 8px !important;
        border: 2px solid #e3f2fd !important;
        background: white !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
    }
    
    .enhanced-dropdown .select2-search__field:focus {
        border-color: #1976d2 !important;
        box-shadow: 0 0 0 0.2rem rgba(25, 118, 210, 0.25) !important;
    }
    
    /* Loading and empty states */
    .select2-container--bootstrap-5 .select2-results__message {
        padding: 20px !important;
        text-align: center !important;
        color: #666 !important;
        font-style: italic !important;
    }
    
    .select2-container--bootstrap-5 .select2-results__option--load-more {
        background: #f8f9fa !important;
        color: #1976d2 !important;
        text-align: center !important;
        font-weight: 600 !important;
        padding: 16px !important;
    }
    
    /* Keyboard navigation improvements */
    .select2-container--bootstrap-5 .select2-results__option[aria-selected="true"] {
        background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%) !important;
        color: white !important;
        font-weight: 600 !important;
    }
    
    /* Animation for dropdown opening */
    .select2-dropdown {
        animation: slideDown 0.2s ease-out !important;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">WorkComp Rates Transparency Dashboard</h4>
                        <p class="text-muted mb-0">Workers' Compensation rate discovery and multi-benchmark analysis</p>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="{% url 'benchmark_compare' %}" class="btn btn-outline-success">
                            <i class="bi bi-bar-chart me-2"></i>Benchmark Comparison
                        </a>
                        <a href="{% url 'steerage_preview' %}" class="btn btn-outline-warning">
                            <i class="bi bi-compass me-2"></i>Steerage Preview
                        </a>
                        <a href="{% url 'data_availability_overview' %}" class="btn btn-outline-info">
                            <i class="fas fa-database me-2"></i>Data Availability
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Navigation to New Views -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-compass me-2"></i> Navigate to New WorkComp Rates Features
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="text-center">
                                <i class="bi bi-graph-up-arrow text-primary" style="font-size: 2.5rem;"></i>
                                <h6 class="mt-2">Transparency Dashboard</h6>
                                <p class="text-muted small">State-specific Workers' Comp analysis</p>
                                <a href="{% url 'transparency' state='GA' %}" class="btn btn-outline-primary btn-sm">
                                    View GA Dashboard
                                </a>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="text-center">
                                <i class="bi bi-bar-chart text-success" style="font-size: 2.5rem;"></i>
                                <h6 class="mt-2">Benchmark Comparison</h6>
                                <p class="text-muted small">Multi-benchmark rate analysis</p>
                                <a href="{% url 'benchmark_compare' %}" class="btn btn-outline-success btn-sm">
                                    Compare Benchmarks
                                </a>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="text-center">
                                <i class="bi bi-compass text-warning" style="font-size: 2.5rem;"></i>
                                <h6 class="mt-2">Steerage Preview</h6>
                                <p class="text-muted small">AI-powered guidance preview</p>
                                <a href="{% url 'steerage_preview' %}" class="btn btn-outline-warning btn-sm">
                                    Preview Steerage
                                </a>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="text-center">
                                <i class="bi bi-database text-info" style="font-size: 2.5rem;"></i>
                                <h6 class="mt-2">Data Availability</h6>
                                <p class="text-muted small">Comprehensive data metrics</p>
                                <a href="{% url 'data_availability_overview' %}" class="btn btn-outline-info btn-sm">
                                    View Availability
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if error_message %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            {{ error_message }}
        </div>
    {% endif %}

    <!-- Filtering Instructions -->
    <div class="partition-summary">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-funnel text-primary me-2"></i>
                    Filtering Instructions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-9">
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Select required records, please filter lower level to improve performance.</strong>
                            <p class="mb-0 mt-2">Use the filters below to narrow down your search criteria for better performance and more targeted results.</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="summary-metric">
                            {% if has_required_filters %}
                                <div class="d-grid gap-2">
                                    <a href="{% url 'dataset_review_loading' %}?{% for key, value in current_filters.items %}{% if key == 'payer_slug' and value|length > 0 %}{% for slug in value %}{{ key }}={{ slug }}&{% endfor %}{% else %}{{ key }}={{ value }}&{% endif %}{% endfor %}" 
                                       class="btn btn-primary btn-lg">
                                        <i class="bi bi-search me-2"></i> Analyze Rates
                                    </a>
                                    {% if current_filters.state %}
                                        <a href="{% url 'transparency' state=current_filters.state %}" class="btn btn-outline-success">
                                            <i class="bi bi-graph-up me-2"></i> Transparency Dashboard
                                        </a>
                                    {% endif %}
                                </div>
                            {% else %}
                                <button class="btn btn-outline-secondary btn-lg" disabled>
                                    <i class="bi bi-lock me-2"></i> Select Required Filters
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Results Summary -->
    {% if current_filters.payer_slug or current_filters.state or current_filters.billing_class %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle me-2"></i>
                        Search Results Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-success mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Found {{ partition_summary.total_estimated_records|intcomma }} records</strong> matching your search criteria.
                        <p class="mb-0 mt-2">These records are distributed across {{ partition_summary.partition_count }} data partitions.</p>
                    </div>
                    
                    <!-- Performance Warning for Large Result Sets -->
                    {% if partition_summary.total_estimated_records > 100000 %}
                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Performance Notice:</strong> Your search returned over 100,000 records. 
                        Please consider adding additional filters (such as procedure set, taxonomy, or time period) to improve performance and reduce loading times.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Hierarchical Filters -->
    <form method="get" id="filterForm">
        <!-- Required Filters (Tier 1) -->
        <div class="filter-tier">
            <div class="card">
                <div class="card-header">
                    <h5 class="filter-tier-title">
                        <i class="bi bi-exclamation-circle text-danger me-2"></i>
                        Required Filters (Select all three to search)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                <div class="col-md-4">
                    <label for="payer_slug" class="form-label fw-bold">
                        <i class="bi bi-building text-primary me-1"></i> Payer *
                    </label>
                    <select class="form-select select2-dropdown" id="payer_slug" name="payer_slug" multiple required>
                        {% for option in filter_options.payer_slug %}
                            {% with option_parts=option|split:'|' %}
                            <option value="{{ option_parts|first }}" 
                                    {% if current_filters.payer_slug and option_parts|first in current_filters.payer_slug %}selected{% endif %}>
                                {{ option_parts|last }}
                            </option>
                            {% endwith %}
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">{{ filter_options.payer_slug|length }} payer(s) available</small>
                </div>
                <div class="col-md-4">
                    <label for="state" class="form-label fw-bold">
                        <i class="bi bi-geo-alt text-info me-1"></i> State *
                    </label>
                    <select class="form-select" id="state" name="state" required>
                        <option value="">Choose a State</option>
                        {% for state in filter_options.state %}
                            <option value="{{ state }}" 
                                    {% if current_filters.state == state %}selected{% endif %}>
                                {{ state }}
                            </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">{{ filter_options.state|length }} state(s) available</small>
                </div>
                <div class="col-md-4">
                    <label for="billing_class" class="form-label fw-bold">
                        <i class="bi bi-file-text text-warning me-1"></i> Billing Class *
                    </label>
                    <select class="form-select" id="billing_class" name="billing_class" required>
                        <option value="">Choose Billing Class</option>
                        {% for billing_class in filter_options.billing_class %}
                            <option value="{{ billing_class }}" 
                                    {% if current_filters.billing_class == billing_class %}selected{% endif %}>
                                {{ billing_class|title }}
                            </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">{{ filter_options.billing_class|length }} billing class(es) available</small>
                </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Optional Filters (Tier 2) -->
        <div class="filter-tier">
            <div class="card">
                <div class="card-header">
                    <h5 class="filter-tier-title">
                        <i class="bi bi-funnel text-warning me-2"></i>
                        Optional Filters (Refine your search)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                <div class="col-md-4">
                    <label for="procedure_set" class="form-label fw-bold">
                        <i class="bi bi-clipboard-pulse text-success me-1"></i> Procedure Set
                    </label>
                    <select class="form-select" id="procedure_set" name="procedure_set">
                        <option value="">All Procedure Sets</option>
                        {% for procedure_set in filter_options.procedure_set %}
                            <option value="{{ procedure_set }}" 
                                    {% if current_filters.procedure_set == procedure_set %}selected{% endif %}>
                                {{ procedure_set }}
                            </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">{{ filter_options.procedure_set|length }} procedure set(s) available</small>
                </div>
                <div class="col-md-4">
                    <label for="taxonomy_desc" class="form-label fw-bold">
                        <i class="bi bi-person-badge text-danger me-1"></i> Taxonomy Description
                    </label>
                    <select class="form-select" id="taxonomy_desc" name="taxonomy_desc">
                        <option value="">All Descriptions</option>
                        {% for desc in filter_options.taxonomy_desc %}
                            <option value="{{ desc }}" 
                                    {% if current_filters.taxonomy_desc == desc %}selected{% endif %}>
                                {{ desc }}
                            </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">{{ filter_options.taxonomy_desc|length }} description(s) available</small>
                </div>
                    </div>
                    <div class="row g-3 mt-3">
                <div class="col-md-4">
                    <label for="taxonomy_code" class="form-label fw-bold">
                        <i class="bi bi-hash text-info me-1"></i> Taxonomy Code
                    </label>
                    <select class="form-select" id="taxonomy_code" name="taxonomy_code">
                        <option value="">All Codes</option>
                        {% for code in filter_options.taxonomy_code %}
                            <option value="{{ code }}" 
                                    {% if current_filters.taxonomy_code == code %}selected{% endif %}>
                                {{ code }}
                            </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">{{ filter_options.taxonomy_code|length }} code(s) available</small>
                </div>
                <div class="col-md-4">
                    <label for="stat_area_name" class="form-label fw-bold">
                        <i class="bi bi-geo text-secondary me-1"></i> Statistical Area
                    </label>
                    <select class="form-select" id="stat_area_name" name="stat_area_name">
                        <option value="">All Areas</option>
                        {% for area in filter_options.stat_area_name %}
                            <option value="{{ area }}" 
                                    {% if current_filters.stat_area_name == area %}selected{% endif %}>
                                {{ area }}
                            </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">{{ filter_options.stat_area_name|length }} area(s) available</small>
                </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Temporal Filters (Tier 3) -->
        <div class="filter-tier">
            <div class="card">
                <div class="card-header">
                    <h5 class="filter-tier-title">
                        <i class="bi bi-calendar text-info me-2"></i>
                        Time Period (Optional)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                <div class="col-md-6">
                    <label for="year" class="form-label fw-bold">
                        <i class="bi bi-calendar-year text-info me-1"></i> Year
                    </label>
                    <select class="form-select" id="year" name="year">
                        <option value="">All Years</option>
                        {% for year in filter_options.year %}
                            <option value="{{ year }}" 
                                    {% if current_filters.year == year %}selected{% endif %}>
                                {{ year }}
                            </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">{{ filter_options.year|length }} year(s) available</small>
                </div>
                <div class="col-md-6">
                    <label for="month" class="form-label fw-bold">
                        <i class="bi bi-calendar-month text-info me-1"></i> Month
                    </label>
                    <select class="form-select" id="month" name="month">
                        <option value="">All Months</option>
                        {% for month in filter_options.month %}
                            <option value="{{ month }}" 
                                    {% if current_filters.month == month %}selected{% endif %}>
                                {{ month }}
                            </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">{{ filter_options.month|length }} month(s) available</small>
                </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Actions -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <button type="submit" class="btn btn-primary btn-lg me-3">
                    <i class="bi bi-search me-2"></i> Search for Rates
                </button>
                <a href="{% url 'commercial_rate_insights' %}" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-x-circle me-2"></i> Clear All Filters
                </a>
            </div>
        </div>
    </form>

    <!-- Data Availability Visualization -->
    {% if partition_summary.available_filters %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-bar-chart text-primary me-2"></i> 
                        Data Availability Overview
                    </h5>
                </div>
                <div class="card-body">


                    <!-- Available Filter Options -->
                    <div class="row">
                        {% for filter_name, options in partition_summary.available_filters.items %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title text-capitalize">
                                        <i class="bi bi-funnel text-info me-1"></i>
                                        {{ filter_name|humanize_field_name }}
                                    </h6>
                                    <div class="mb-2">
                                        <span class="badge bg-primary">{{ options|length }} options</span>
                                    </div>
                                    <div class="filter-options-preview" style="max-height: 120px; overflow-y: auto;">
                                        {% for option in options|slice:":10" %}
                                        <span class="badge bg-light text-dark me-1 mb-1">{{ option }}</span>
                                        {% endfor %}
                                        {% if options|length > 10 %}
                                        <span class="badge bg-secondary">+{{ options|length|add:"-10" }} more</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>


                    <!-- Time Period Distribution -->
                    {% if partition_summary.available_filters.year or partition_summary.available_filters.month %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-calendar text-warning me-1"></i>
                                        Time Period Distribution
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        {% if partition_summary.available_filters.year %}
                                        <div class="col-md-6">
                                            <h6>Years Available</h6>
                                            <div class="d-flex flex-wrap">
                                                {% for year in partition_summary.available_filters.year %}
                                                <span class="badge bg-warning me-1 mb-1">{{ year }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% if partition_summary.available_filters.month %}
                                        <div class="col-md-6">
                                            <h6>Months Available</h6>
                                            <div class="d-flex flex-wrap">
                                                {% for month in partition_summary.available_filters.month %}
                                                <span class="badge bg-info me-1 mb-1">{{ month }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
$(document).ready(function() {
    // Initialize Select2 for single select dropdowns with enhanced search
    $('.form-select:not(.select2-dropdown)').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: function() {
            return $(this).find('option:first').text();
        },
        allowClear: true,
        minimumResultsForSearch: 0, // Always show search box
        dropdownCssClass: 'enhanced-dropdown',
        language: {
            noResults: function() {
                return "No matching options found";
            },
            searching: function() {
                return "Searching...";
            },
            inputTooShort: function() {
                return "Type to search...";
            }
        }
    });
    
    // Initialize Select2 for multiple select dropdowns (payer selection) with enhanced features
    $('.select2-dropdown').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Type to search and select payers...',
        allowClear: true,
        closeOnSelect: false,
        minimumResultsForSearch: 0, // Always show search box
        dropdownCssClass: 'enhanced-dropdown',
        language: {
            noResults: function() {
                return "No matching payers found";
            },
            searching: function() {
                return "Searching payers...";
            },
            inputTooShort: function() {
                return "Type to search payers...";
            },
            maximumSelected: function(args) {
                return "You can only select " + args.maximum + " items";
            }
        },
        matcher: function(params, data) {
            // Enhanced search functionality
            if ($.trim(params.term) === '') {
                return data;
            }
            
            if (typeof data.text === 'undefined') {
                return null;
            }
            
            // Case-insensitive search
            var searchTerm = params.term.toLowerCase();
            var searchText = data.text.toLowerCase();
            
            // Search in both display name and slug
            if (searchText.indexOf(searchTerm) > -1) {
                return data;
            }
            
            return null;
        }
    });
    
    // Add form validation
    $('#filterForm').on('submit', function(e) {
        const requiredFields = ['payer_slug', 'state', 'billing_class'];
        let isValid = true;
        
        requiredFields.forEach(function(field) {
            const $field = $('#' + field);
            const value = $field.val();
            
            // Handle multiple select fields (payer_slug)
            if (field === 'payer_slug') {
                if (!value || value.length === 0) {
                    $field.addClass('is-invalid');
                    isValid = false;
                } else {
                    $field.removeClass('is-invalid');
                }
            } else {
                // Handle single select fields
                if (!value) {
                    $field.addClass('is-invalid');
                    isValid = false;
                } else {
                    $field.removeClass('is-invalid');
                }
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('Please select all required filters: Payer, State, and Billing Class');
        }
    });

});

</script>
{% endblock %}
