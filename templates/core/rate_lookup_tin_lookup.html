{% extends 'base.html' %}
{% load static %}

{% block title %}TIN Lookup - Market Rate Lookup{% endblock %}

{% block extra_head %}
<style>
    .search-card {
        border-radius: 15px;
        border: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .result-card {
        border-radius: 10px;
        border: none;
        transition: transform 0.2s ease-in-out;
    }
    
    .result-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .tin-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: bold;
    }
    
    .s3-tile-card {
        border-left: 4px solid #28a745;
        background: #f8f9fa;
    }
    
    .s3-tile-card.unavailable {
        border-left-color: #dc3545;
        background: #fff5f5;
    }
    
    .stat-badge {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.875rem;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'rate_lookup_home' %}">Rate Lookup</a></li>
                    <li class="breadcrumb-item active">TIN Lookup</li>
                </ol>
            </nav>
            <h1 class="display-6 fw-bold text-primary mb-3">
                <i class="bi bi-building me-3"></i>TIN Lookup
            </h1>
            <p class="lead text-muted">
                Search for Tax Identification Numbers (TINs) and organizations to explore available market rate data.
            </p>
        </div>
    </div>

    <!-- Search Form -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card search-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-search me-2"></i>Search TINs & Organizations
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" class="row g-3">
                        {% csrf_token %}
                        <div class="col-md-4">
                            <label for="search_type" class="form-label">Search Type</label>
                            <select class="form-select" id="search_type" name="search_type" required>
                                <option value="">Select search type...</option>
                                <option value="tin" {% if search_type == 'tin' %}selected{% endif %}>TIN Number</option>
                                <option value="organization" {% if search_type == 'organization' %}selected{% endif %}>Organization Name</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="search_query" class="form-label">Search Query</label>
                            <input type="text" class="form-control" id="search_query" name="search_query" 
                                   placeholder="Enter TIN or organization name..." 
                                   value="{{ search_query|default:'' }}" required>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-search me-2"></i>Search
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Message -->
    {% if error_message %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>{{ error_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Search Results -->
    {% if search_results %}
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="fw-bold text-primary mb-3">
                <i class="bi bi-list-ul me-2"></i>Search Results
                <span class="badge bg-primary ms-2">{{ search_results|length }} result{{ search_results|length|pluralize }}</span>
            </h4>
        </div>
    </div>

    <!-- TIN Data -->
    {% if tin_data %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card result-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-building me-2"></i>Organization Information
                        <span class="tin-badge float-end">{{ tin_data.tin_value }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Organization Details</h6>
                            <ul class="list-unstyled">
                                <li><strong>Name:</strong> {{ tin_data.organization_name|default:"N/A" }}</li>
                                <li><strong>Address:</strong> {{ tin_data.address_1|default:"N/A" }}</li>
                                {% if tin_data.address_2 %}
                                <li><strong>Address 2:</strong> {{ tin_data.address_2 }}</li>
                                {% endif %}
                                <li><strong>City:</strong> {{ tin_data.city|default:"N/A" }}</li>
                                <li><strong>State:</strong> {{ tin_data.state|default:"N/A" }}</li>
                                <li><strong>ZIP:</strong> {{ tin_data.zip_norm|default:"N/A" }}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Location Details</h6>
                            <ul class="list-unstyled">
                                <li><strong>NPI Count:</strong> {{ tin_data.support_npi_count|default:"N/A" }}</li>
                                <li><strong>Primary Location:</strong> 
                                    {% if tin_data.primary_flag %}
                                        <span class="badge bg-success">Yes</span>
                                    {% else %}
                                        <span class="badge bg-secondary">No</span>
                                    {% endif %}
                                </li>
                                <li><strong>Primary Basis:</strong> {{ tin_data.primary_basis|default:"N/A" }}</li>
                                {% if tin_data.latitude and tin_data.longitude %}
                                <li><strong>Coordinates:</strong> {{ tin_data.latitude }}, {{ tin_data.longitude }}</li>
                                {% endif %}
                                <li><strong>Last Updated:</strong> {{ tin_data.last_updated|default:"N/A" }}</li>
                            </ul>
                        </div>
                    </div>
                    
                    {% if tin_data.npi_list_json %}
                    <div class="mt-3">
                        <h6 class="text-primary">Associated NPIs</h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% for npi in tin_data.npi_list_json %}
                            <span class="badge bg-info">{{ npi }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- S3 Availability -->
    {% if s3_availability %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card result-card">
                <div class="card-header {% if s3_availability.available %}bg-success{% else %}bg-danger{% endif %} text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-cloud me-2"></i>S3 Data Availability
                        {% if s3_availability.available %}
                        <span class="badge bg-light text-success ms-2">{{ s3_availability.total_tiles }} tile{{ s3_availability.total_tiles|pluralize }}</span>
                        {% else %}
                        <span class="badge bg-light text-danger ms-2">No Data</span>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if s3_availability.available %}
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="stat-badge text-center d-block">
                                <div class="fs-4 fw-bold">{{ s3_availability.total_tiles }}</div>
                                <div class="small">Total Tiles</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-badge text-center d-block">
                                <div class="fs-4 fw-bold">{{ s3_availability.total_rows|floatformat:0 }}</div>
                                <div class="small">Total Rows</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-success me-2">Available</span>
                                <span class="text-muted">Data is available in S3 tiles for analysis</span>
                            </div>
                        </div>
                    </div>

                    <!-- S3 Tiles Details -->
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Ready to analyze rates?</strong> Click "Analyze This Tile" on any tile below to view detailed rate data and export to CSV.
                    </div>
                    <div class="row">
                        {% for tile in s3_availability.tiles %}
                        <div class="col-md-6 mb-3">
                            <div class="card s3-tile-card">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="bi bi-file-earmark-text me-2"></i>{{ tile.payer_slug }}
                                    </h6>
                                    <ul class="list-unstyled small">
                                        <li><strong>Billing Class:</strong> {{ tile.billing_class }}</li>
                                        <li><strong>Procedure Set:</strong> {{ tile.proc_set }}</li>
                                        <li><strong>Procedure Class:</strong> {{ tile.proc_class }}</li>
                                        <li><strong>Procedure Group:</strong> {{ tile.proc_group }}</li>
                                        <li><strong>Rows:</strong> {{ tile.row_count|floatformat:0 }}</li>
                                        <li><strong>Created:</strong> {{ tile.created_at_utc }}</li>
                                    </ul>
                                    {% if tile.billing_codes_json %}
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <strong>Sample Codes:</strong> 
                                            {% for code in tile.billing_codes_json|slice:":5" %}
                                                <span class="badge bg-secondary me-1">{{ code }}</span>
                                            {% endfor %}
                                            {% if tile.billing_codes_json|length > 5 %}
                                                <span class="text-muted">+{{ tile.billing_codes_json|length|add:"-5" }} more</span>
                                            {% endif %}
                                        </small>
                                    </div>
                                    {% endif %}
                                    <div class="mt-3 text-center">
                                        <a href="{% url 'tile_analyzer' %}?s3_prefix={{ tile.s3_prefix|urlencode }}&tin_value={{ tin_data.tin_value }}&payer_slug={{ tile.payer_slug|urlencode }}&billing_class={{ tile.billing_class|urlencode }}&proc_set={{ tile.proc_set|urlencode }}&proc_class={{ tile.proc_class|urlencode }}&proc_group={{ tile.proc_group|urlencode }}" 
                                           class="btn btn-primary btn-sm w-100">
                                            <i class="bi bi-bar-chart-fill me-2"></i>Analyze This Tile
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-cloud-slash text-danger" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-danger">No S3 Data Available</h5>
                        <p class="text-muted">This TIN does not have any data available in S3 tiles.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- All Search Results -->
    {% if search_results|length > 1 %}
    <div class="row">
        <div class="col-12">
            <h5 class="fw-bold text-primary mb-3">
                <i class="bi bi-list me-2"></i>All Results
            </h5>
            <div class="row">
                {% for result in search_results %}
                <div class="col-md-6 mb-3">
                    <div class="card result-card">
                        <div class="card-body">
                            <h6 class="card-title">
                                <span class="tin-badge me-2">{{ result.tin_value }}</span>
                                {{ result.organization_name|default:"Unknown Organization" }}
                            </h6>
                            <ul class="list-unstyled small">
                                <li><strong>Address:</strong> {{ result.address_1|default:"N/A" }}</li>
                                <li><strong>City, State:</strong> {{ result.city|default:"N/A" }}, {{ result.state|default:"N/A" }}</li>
                                <li><strong>ZIP:</strong> {{ result.zip_norm|default:"N/A" }}</li>
                                <li><strong>NPI Count:</strong> {{ result.support_npi_count|default:"N/A" }}</li>
                            </ul>
                            <a href="{% url 'rate_lookup_tin_details' result.tin_value %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye me-1"></i>View Details
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {% elif search_query %}
    <!-- No Results -->
    <div class="row">
        <div class="col-12">
            <div class="text-center py-5">
                <i class="bi bi-search text-muted" style="font-size: 4rem;"></i>
                <h4 class="mt-3 text-muted">No Results Found</h4>
                <p class="text-muted">No {{ search_type }} found matching "{{ search_query }}"</p>
                <a href="{% url 'market_rate_tin_lookup' %}" class="btn btn-primary">
                    <i class="bi bi-arrow-left me-2"></i>Try Another Search
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-focus search input
        const searchInput = document.getElementById('search_query');
        if (searchInput) {
            searchInput.focus();
        }
        
        // Form validation
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const searchType = document.getElementById('search_type').value;
                const searchQuery = document.getElementById('search_query').value.trim();
                
                if (!searchType) {
                    e.preventDefault();
                    alert('Please select a search type.');
                    return;
                }
                
                if (!searchQuery) {
                    e.preventDefault();
                    alert('Please enter a search query.');
                    return;
                }
            });
        }
    });
</script>
{% endblock %}
