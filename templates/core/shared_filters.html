{% load humanize %}

<!-- Active Filters Summary -->
<div class="row mb-3">
    <div class="col-12">
        <div class="active-filters-summary" id="activeFiltersSummary" style="display: none;">
            <div class="alert alert-info d-flex align-items-center justify-content-between">
                <div>
                    <i class="fas fa-filter"></i>
                    <strong>Active Filters:</strong>
                    <span id="activeFiltersText">No filters applied</span>
                </div>
                <button type="button" class="btn btn-sm btn-outline-info" onclick="clearAllFilters()">
                    <i class="fas fa-times"></i> Clear All
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Filters Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" onclick="toggleFilters()">
                <div class="d-flex align-items-center">
                    <h5 class="card-title mb-0 me-2">
                        <i class="fas fa-filter"></i> Filters
                    </h5>
                    <small class="text-muted">(Click here to expand/collapse view)</small>
                </div>
                <i class="fas fa-chevron-right" id="filterToggleIcon"></i>
            </div>
            <div class="card-body" id="filterCardBody" style="display: none;">
                <form method="get" id="filterForm">
                    <!-- Tier 1: High-Level Filters -->
                    <div class="filter-tier">
                        <h6 class="filter-tier-title">
                            <i class="fas fa-globe text-primary"></i>
                            High-Level Filters
                        </h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="payer" class="form-label fw-bold">
                                    <i class="fas fa-building text-info"></i> Payer
                                </label>
                                <select class="form-select filter-select select2-dropdown" id="payer" name="payer" data-filter="payer" multiple>
                                    {% for payer in filters.payers %}
                                        <option value="{{ payer }}" {% if payer in active_filters.payer %}selected{% endif %}>{{ payer }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="org_name" class="form-label fw-bold">
                                    <i class="fas fa-hospital text-success"></i> Organization
                                </label>
                                <select class="form-select filter-select select2-dropdown" id="org_name" name="org_name" data-filter="org_name" multiple>
                                    {% for org in filters.organizations %}
                                        <option value="{{ org }}" {% if org in active_filters.org_name %}selected{% endif %}>{{ org }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Tier 2: Geographic & Regional Filters -->
                    <div class="filter-tier">
                        <h6 class="filter-tier-title">
                            <i class="fas fa-map-marker-alt text-warning"></i>
                            Geographic & Regional
                        </h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="cbsa" class="form-label fw-bold">
                                    <i class="fas fa-map text-warning"></i> CBSA Region
                                </label>
                                <select class="form-select filter-select select2-dropdown" id="cbsa" name="cbsa" data-filter="cbsa" multiple>
                                    {% for region in filters.cbsa_regions %}
                                        <option value="{{ region }}" {% if region in active_filters.cbsa %}selected{% endif %}>{{ region }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="tin_value" class="form-label fw-bold">
                                    <i class="fas fa-id-card text-secondary"></i> TIN Values
                                </label>
                                <select class="form-select filter-select select2-dropdown" id="tin_value" name="tin_value" data-filter="tin_value" multiple>
                                    {% for tin in filters.tin_values %}
                                        <option value="{{ tin }}" {% if tin in active_filters.tin_value %}selected{% endif %}>{{ tin }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tier 3: Procedure & Service Filters -->
                    <div class="filter-tier">
                        <h6 class="filter-tier-title">
                            <i class="fas fa-stethoscope text-danger"></i>
                            Procedure & Service Classification
                        </h6>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label for="procedure_set" class="form-label fw-bold">
                                    <i class="fas fa-layer-group text-danger"></i> Procedure Set
                                </label>
                                <select class="form-select filter-select select2-dropdown" id="procedure_set" name="procedure_set" data-filter="procedure_set" multiple>
                                    {% for set in filters.procedure_sets %}
                                        <option value="{{ set }}" {% if set in active_filters.procedure_set %}selected{% endif %}>{{ set }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="procedure_class" class="form-label fw-bold">
                                    <i class="fas fa-tags text-danger"></i> Procedure Class
                                </label>
                                <select class="form-select filter-select select2-dropdown" id="procedure_class" name="procedure_class" data-filter="procedure_class" multiple>
                                    {% for class in filters.procedure_classes %}
                                        <option value="{{ class }}" {% if class in active_filters.procedure_class %}selected{% endif %}>{{ class }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="procedure_group" class="form-label fw-bold">
                                    <i class="fas fa-object-group text-danger"></i> Procedure Group
                                </label>
                                <select class="form-select filter-select select2-dropdown" id="procedure_group" name="procedure_group" data-filter="procedure_group" multiple>
                                    {% for group in filters.procedure_groups %}
                                        <option value="{{ group }}" {% if group in active_filters.procedure_group %}selected{% endif %}>{{ group }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tier 4: Detailed Service & Provider Filters -->
                    <div class="filter-tier">
                        <h6 class="filter-tier-title">
                            <i class="fas fa-microscope text-info"></i>
                            Detailed Service & Provider
                        </h6>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label for="billing_code" class="form-label fw-bold">
                                    <i class="fas fa-barcode text-info"></i> Billing Code
                                </label>
                                <select class="form-select filter-select select2-dropdown" id="billing_code" name="billing_code" data-filter="billing_code" multiple>
                                    {% for code in filters.billing_codes %}
                                        <option value="{{ code }}" {% if code in active_filters.billing_code %}selected{% endif %}>{{ code }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="primary_taxonomy_code" class="form-label fw-bold">
                                    <i class="fas fa-user-md text-info"></i> Taxonomy Code
                                </label>
                                <select class="form-select filter-select select2-dropdown" id="primary_taxonomy_code" name="primary_taxonomy_code" data-filter="primary_taxonomy_code" multiple>
                                    {% for code in filters.primary_taxonomy_codes %}
                                        <option value="{{ code }}" {% if code in active_filters.primary_taxonomy_code %}selected{% endif %}>{{ code }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="primary_taxonomy_desc" class="form-label fw-bold">
                                    <i class="fas fa-user-nurse text-info"></i> Taxonomy Description
                                </label>
                                <select class="form-select filter-select select2-dropdown" id="primary_taxonomy_desc" name="primary_taxonomy_desc" data-filter="primary_taxonomy_desc" multiple>
                                    {% for desc in filters.primary_taxonomy_descs %}
                                        <option value="{{ desc }}" {% if desc in active_filters.primary_taxonomy_desc %}selected{% endif %}>{{ desc }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="filter-actions">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                        <a href="{{ request.path }}" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-undo"></i> Reset All
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Base State Statistics -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">{{ state_name }} Analysis Statistics</h5>
                <p class="text-muted mb-0">Performance metrics with current filters</p>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Professional Rates -->
                    <div class="col-md-6">
                        <h6 class="text-primary">Professional Rates</h6>
                        <div class="row">
                            <div class="col-6">
                                <p class="mb-1"><strong>Avg Rate:</strong></p>
                                <p class="text-muted">${{ base_stats.professional.avg_rate|floatformat:0|intcomma }}</p>
                            </div>
                            <div class="col-6">
                                <p class="mb-1"><strong>Records:</strong></p>
                                <p class="text-muted">{{ base_stats.professional.record_count|intcomma }}</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <p class="mb-1"><strong>GA WCFS PROF:</strong></p>
                                <p class="text-muted h5">{{ base_stats.professional.ga_prof_pct|floatformat:1 }}% of GA</p>
                                <p class="text-muted small">${{ base_stats.professional.ga_prof_mar|floatformat:2|intcomma }}</p>
                            </div>
                            <div class="col-6">
                                <p class="mb-1"><strong>Medicare:</strong></p>
                                <p class="text-muted h5">{{ base_stats.professional.medicare_prof_pct|floatformat:1 }}% of Medicare</p>
                                <p class="text-muted small">${{ base_stats.professional.medicare_prof_mar|floatformat:2|intcomma }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Facility Rates -->
                    <div class="col-md-6">
                        <h6 class="text-info">Facility Rates</h6>
                        <div class="row">
                            <div class="col-6">
                                <p class="mb-1"><strong>Avg Rate:</strong></p>
                                <p class="text-muted">${{ base_stats.facility.avg_rate|floatformat:0|intcomma }}</p>
                            </div>
                            <div class="col-6">
                                <p class="mb-1"><strong>Records:</strong></p>
                                <p class="text-muted">{{ base_stats.facility.record_count|intcomma }}</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <p class="mb-1"><strong>GA WCFS OP MAR:</strong></p>
                                <p class="text-muted h5">{{ base_stats.facility.ga_op_pct|floatformat:1 }}% of GA OP</p>
                                <p class="text-muted small">${{ base_stats.facility.ga_op_mar|floatformat:2|intcomma }}</p>
                            </div>
                            <div class="col-6">
                                <p class="mb-1"><strong>GA WCFS ASC MAR:</strong></p>
                                <p class="text-muted h5">{{ base_stats.facility.ga_asc_pct|floatformat:1 }}% of GA ASC</p>
                                <p class="text-muted small">${{ base_stats.facility.ga_asc_mar|floatformat:2|intcomma }}</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <p class="mb-1"><strong>MEDICARE OP MAR:</strong></p>
                                <p class="text-muted h5">{{ base_stats.facility.medicare_op_pct|floatformat:1 }}% of Medicare OP</p>
                                <p class="text-muted small">${{ base_stats.facility.medicare_op_mar|floatformat:2|intcomma }}</p>
                            </div>
                            <div class="col-6">
                                <p class="mb-1"><strong>MEDICARE ASC MAR:</strong></p>
                                <p class="text-muted h5">{{ base_stats.facility.medicare_asc_pct|floatformat:1 }}% of Medicare ASC</p>
                                <p class="text-muted small">${{ base_stats.facility.medicare_asc_mar|floatformat:2|intcomma }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
