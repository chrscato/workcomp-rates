{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Data Availability Overview - WorkComp Rates{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/insights_overview.css' %}">
<style>
    .metric-card {
        transition: transform 0.2s ease-in-out;
        border-left: 4px solid #007bff;
    }
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .breakdown-table {
        font-size: 0.9rem;
    }
    .breakdown-table th {
        background-color: #f8f9fa;
        border-top: none;
    }
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
    }
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .coverage-bar {
        height: 8px;
        border-radius: 4px;
        background: #e9ecef;
        overflow: hidden;
    }
    .coverage-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
    }
    .section-header {
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    {% if has_data %}
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">
                                <i class="bi bi-database text-primary me-2"></i>
                                Data Availability Overview
                            </h4>
                            <p class="text-muted mb-0">
                                Comprehensive data availability metrics from partition navigation database
                            </p>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="{% url 'commercial_rate_insights' %}" class="btn btn-outline-primary">
                                <i class="bi bi-graph-up-arrow me-2"></i>Go to Insights
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-pie-chart text-primary me-2"></i>
                            Overall Data Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2 col-sm-4 mb-3">
                                <div class="text-center">
                                    <div class="stat-number text-primary">{{ availability_metrics.summary_stats.partition_count|intcomma }}</div>
                                    <div class="stat-label">Total Partitions</div>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 mb-3">
                                <div class="text-center">
                                    <div class="stat-number text-success">{{ availability_metrics.summary_stats.total_estimated_records|intcomma }}</div>
                                    <div class="stat-label">Total Records</div>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 mb-3">
                                <div class="text-center">
                                    <div class="stat-number text-info">{{ availability_metrics.summary_stats.total_size_mb|floatformat:1 }} MB</div>
                                    <div class="stat-label">Data Size</div>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 mb-3">
                                <div class="text-center">
                                    <div class="stat-number text-warning">{{ availability_metrics.summary_stats.unique_payers }}</div>
                                    <div class="stat-label">Payers</div>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 mb-3">
                                <div class="text-center">
                                    <div class="stat-number text-danger">{{ availability_metrics.summary_stats.unique_states }}</div>
                                    <div class="stat-label">States/Territories</div>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 mb-3">
                                <div class="text-center">
                                    <div class="stat-number text-secondary">{{ availability_metrics.summary_stats.unique_taxonomies }}</div>
                                    <div class="stat-label">Medical Specialties</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Breakdowns -->
        <div class="row">
            <!-- Payer Breakdown -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-building text-primary me-2"></i>
                            Payer Breakdown
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover breakdown-table">
                                <thead>
                                    <tr>
                                        <th>Payer</th>
                                        <th class="text-end">Records</th>
                                        <th class="text-end">Partitions</th>
                                        <th class="text-end">Size (MB)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for payer in availability_metrics.payer_breakdown %}
                                    <tr>
                                        <td>
                                            <strong>{{ payer.payer_display_name|default:"Unknown Payer" }}</strong>
                                            <br>
                                            <small class="text-muted">{{ payer.payer_slug }}</small>
                                        </td>
                                        <td class="text-end">
                                            <span class="badge bg-primary">{{ payer.total_estimated_records|intcomma }}</span>
                                        </td>
                                        <td class="text-end">{{ payer.partition_count|intcomma }}</td>
                                        <td class="text-end">{{ payer.total_size_mb|floatformat:1 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- State Breakdown -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-geo-alt text-success me-2"></i>
                            Top States by Records
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover breakdown-table">
                                <thead>
                                    <tr>
                                        <th>State</th>
                                        <th class="text-end">Records</th>
                                        <th class="text-end">Partitions</th>
                                        <th class="text-end">Size (MB)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for state in availability_metrics.state_breakdown %}
                                    <tr>
                                        <td>
                                            <strong>{{ state.state|default:"Unknown" }}</strong>
                                        </td>
                                        <td class="text-end">
                                            <span class="badge bg-success">{{ state.total_estimated_records|intcomma }}</span>
                                        </td>
                                        <td class="text-end">{{ state.partition_count|intcomma }}</td>
                                        <td class="text-end">{{ state.total_size_mb|floatformat:1 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Billing Class Breakdown -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-file-earmark-text text-info me-2"></i>
                            Billing Class Breakdown
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover breakdown-table">
                                <thead>
                                    <tr>
                                        <th>Billing Class</th>
                                        <th class="text-end">Records</th>
                                        <th class="text-end">Partitions</th>
                                        <th class="text-end">Size (MB)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for billing_class in availability_metrics.billing_class_breakdown %}
                                    <tr>
                                        <td>
                                            <strong>{{ billing_class.billing_class|title }}</strong>
                                        </td>
                                        <td class="text-end">
                                            <span class="badge bg-info">{{ billing_class.total_estimated_records|intcomma }}</span>
                                        </td>
                                        <td class="text-end">{{ billing_class.partition_count|intcomma }}</td>
                                        <td class="text-end">{{ billing_class.total_size_mb|floatformat:1 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Procedure Set Breakdown -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-clipboard-pulse text-warning me-2"></i>
                            Procedure Set Breakdown
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover breakdown-table">
                                <thead>
                                    <tr>
                                        <th>Procedure Set</th>
                                        <th class="text-end">Records</th>
                                        <th class="text-end">Partitions</th>
                                        <th class="text-end">Size (MB)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for proc_set in availability_metrics.procedure_set_breakdown %}
                                    <tr>
                                        <td>
                                            <strong>{{ proc_set.procedure_set|title }}</strong>
                                        </td>
                                        <td class="text-end">
                                            <span class="badge bg-warning">{{ proc_set.total_estimated_records|intcomma }}</span>
                                        </td>
                                        <td class="text-end">{{ proc_set.partition_count|intcomma }}</td>
                                        <td class="text-end">{{ proc_set.total_size_mb|floatformat:1 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Medical Specialties Breakdown -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-person-heart text-danger me-2"></i>
                            Top Medical Specialties
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover breakdown-table">
                                <thead>
                                    <tr>
                                        <th>Specialty</th>
                                        <th class="text-end">Records</th>
                                        <th class="text-end">Partitions</th>
                                        <th class="text-end">Size (MB)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for taxonomy in availability_metrics.taxonomy_breakdown %}
                                    <tr>
                                        <td>
                                            <strong>{{ taxonomy.taxonomy_desc|title }}</strong>
                                            <br>
                                            <small class="text-muted">{{ taxonomy.taxonomy_code }}</small>
                                        </td>
                                        <td class="text-end">
                                            <span class="badge bg-danger">{{ taxonomy.total_estimated_records|intcomma }}</span>
                                        </td>
                                        <td class="text-end">{{ taxonomy.partition_count|intcomma }}</td>
                                        <td class="text-end">{{ taxonomy.total_size_mb|floatformat:1 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time Period Breakdown -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-calendar3 text-secondary me-2"></i>
                            Time Period Breakdown
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover breakdown-table">
                                <thead>
                                    <tr>
                                        <th>Year/Month</th>
                                        <th class="text-end">Records</th>
                                        <th class="text-end">Partitions</th>
                                        <th class="text-end">Size (MB)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for period in availability_metrics.time_period_breakdown %}
                                    <tr>
                                        <td>
                                            <strong>{{ period.year }}/{{ period.month|stringformat:"02d" }}</strong>
                                        </td>
                                        <td class="text-end">
                                            <span class="badge bg-secondary">{{ period.total_estimated_records|intcomma }}</span>
                                        </td>
                                        <td class="text-end">{{ period.partition_count|intcomma }}</td>
                                        <td class="text-end">{{ period.total_size_mb|floatformat:1 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistical Areas Breakdown -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-map text-primary me-2"></i>
                            Top Statistical Areas (CBSA)
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover breakdown-table">
                                <thead>
                                    <tr>
                                        <th>Statistical Area</th>
                                        <th class="text-end">Records</th>
                                        <th class="text-end">Partitions</th>
                                        <th class="text-end">Size (MB)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for area in availability_metrics.stat_area_breakdown %}
                                    <tr>
                                        <td>
                                            <strong>{{ area.stat_area_name|title }}</strong>
                                        </td>
                                        <td class="text-end">
                                            <span class="badge bg-primary">{{ area.total_estimated_records|intcomma }}</span>
                                        </td>
                                        <td class="text-end">{{ area.partition_count|intcomma }}</td>
                                        <td class="text-end">{{ area.total_size_mb|floatformat:1 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <!-- Error State -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                        <h4 class="mt-3">Unable to Load Data</h4>
                        <p class="text-muted">{{ error_message|default:"An error occurred while loading data availability metrics." }}</p>
                        <a href="{% url 'home' %}" class="btn btn-primary">
                            <i class="bi bi-house me-2"></i>Return to Home
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}
