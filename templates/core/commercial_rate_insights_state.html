{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ state_name }} Commercial Rate Insights - WorkComp Rates{% endblock %}

{% block extra_head %}
<!-- jQuery (required for Select2) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- Select2 for enhanced dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- Plotly for data visualization -->
<script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
<!-- Shared filter styles -->
<link rel="stylesheet" href="{% static 'css/shared_filters.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    {% if has_data %}
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">{{ state_name }} Commercial Rate Insights</h4>
                            <p class="text-muted mb-0">State Code: {{ state_code }}</p>
                        </div>
                        <div>
                            <a href="{% url 'commercial_rate_insights_map' %}" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-map"></i> Back to Map
                            </a>
                            <a href="{% url 'commercial_rate_insights_overview' state_code %}" class="btn btn-outline-info me-2">
                                <i class="fas fa-database"></i> Data Overview
                            </a>
                            <a href="{% url 'commercial_rate_insights_compare' state_code %}" class="btn btn-outline-primary me-2">
                                <i class="fas fa-columns"></i> Compare Organizations/Payers
                            </a>
                            <a href="{% url 'custom_network_analysis' state_code %}" class="btn btn-outline-warning">
                                <i class="fas fa-network-wired"></i> Custom Network Analysis
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prefilter Summary (if any) -->
        {% if active_filters %}
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-success d-flex align-items-center justify-content-between">
                        <div>
                            <i class="fas fa-filter"></i>
                            <strong>Active Prefilters Applied:</strong>
                            <span>
                                {% for key, value in active_filters.items %}
                                    <span class="badge bg-primary me-2">{{ key|title }}: {{ value }}</span>
                                {% endfor %}
                            </span>
                        </div>
                        <div>
                            <a href="{% url 'commercial_rate_insights_overview' state_code %}" class="btn btn-sm btn-outline-success me-2">
                                <i class="fas fa-edit"></i> Modify Prefilters
                            </a>
                            <a href="{% url 'commercial_rate_insights_state' state_code %}" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-times"></i> Clear All
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Shared Filters Template -->
        {% include 'core/shared_filters.html' %}

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <!-- Professional Rates -->
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Professional Rates</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="stats-card">
                                    <h3>${{ stats.professional.avg_rate|floatformat:0|intcomma }}</h3>
                                    <p>Average Rate</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stats-card">
                                    <h3>{{ stats.professional.record_count|intcomma }}</h3>
                                    <p>Records</p>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-6">
                                <p class="mb-1"><strong>GA WCFS PROF:</strong></p>
                                <p class="text-muted h5">{{ stats.professional.ga_prof_pct|floatformat:1 }}% of GA</p>
                                <p class="text-muted small">${{ stats.professional.ga_prof_mar|floatformat:2|intcomma }}</p>
                            </div>
                            <div class="col-6">
                                <p class="mb-1"><strong>Medicare Professional:</strong></p>
                                <p class="text-muted h5">{{ stats.professional.medicare_prof_pct|floatformat:1 }}% of Medicare</p>
                                <p class="text-muted small">${{ stats.professional.medicare_prof_mar|floatformat:2|intcomma }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Facility Rates -->
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Facility Rates</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="stats-card">
                                    <h3>${{ stats.facility.avg_rate|floatformat:0|intcomma }}</h3>
                                    <p>Average Rate</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stats-card">
                                    <h3>{{ stats.facility.record_count|intcomma }}</h3>
                                    <p>Records</p>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-6">
                                <p class="mb-1"><strong>GA WCFS OP MAR:</strong></p>
                                <p class="text-muted h5">{{ stats.facility.ga_op_pct|floatformat:1 }}% of GA OP</p>
                                <p class="text-muted small">${{ stats.facility.ga_op_mar|floatformat:2|intcomma }}</p>
                            </div>
                            <div class="col-6">
                                <p class="mb-1"><strong>GA WCFS ASC MAR:</strong></p>
                                <p class="text-muted h5">{{ stats.facility.ga_asc_pct|floatformat:1 }}% of GA ASC</p>
                                <p class="text-muted small">${{ stats.facility.ga_asc_mar|floatformat:2|intcomma }}</p>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6">
                                <p class="mb-1"><strong>MEDICARE OP MAR:</strong></p>
                                <p class="text-muted h5">{{ stats.facility.medicare_op_pct|floatformat:1 }}% of Medicare OP</p>
                                <p class="text-muted small">${{ stats.facility.medicare_op_mar_stateavg|floatformat:2|intcomma }}</p>
                            </div>
                            <div class="col-6">
                                <p class="mb-1"><strong>MEDICARE ASC MAR:</strong></p>
                                <p class="text-muted h5">{{ stats.facility.medicare_asc_pct|floatformat:1 }}% of Medicare ASC</p>
                                <p class="text-muted small">${{ stats.facility.medicare_asc_mar_stateavg|floatformat:2|intcomma }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sample Records Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Sample Records</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Billing Code</th>
                                        <th>Description</th>
                                        <th>Organization</th>
                                        <th>Payer</th>
                                        <th>TIN #</th>
                                        <th>Taxonomy Code</th>
                                        <th>Taxonomy Description</th>
                                        <th class="text-end">Rate</th>
                                        <th class="text-end">GA Prof</th>
                                        <th class="text-end">Medicare Prof</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in sample_records %}
                                    <tr>
                                        <td>{{ record.billing_code }}</td>
                                        <td>{{ record.code_desc }}</td>
                                        <td>{{ record.org_name }}</td>
                                        <td>{{ record.payer }}</td>
                                        <td>{{ record.tin_value }}</td>
                                        <td>{{ record.primary_taxonomy_code }}</td>
                                        <td>{{ record.primary_taxonomy_desc }}</td>
                                        <td class="text-end">${{ record.rate|floatformat:2|intcomma }}</td>
                                        <td class="text-end">${{ record.ga_prof_mar|floatformat:2|intcomma|default:"-" }}</td>
                                        <td class="text-end">${{ record.medicare_prof_mar|floatformat:2|intcomma|default:"-" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="text-warning mb-3">
                            <i class="fas fa-exclamation-triangle"></i>
                            {{ error_message }}
                        </h3>
                        <p class="text-muted mb-4">
                            The data for {{ state_name }} ({{ state_code }}) is not currently available.
                        </p>
                        <a href="{% url 'commercial_rate_insights_map' %}" class="btn btn-primary">
                            <i class="fas fa-map"></i> Back to State Map
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

{% if has_data %}
    {% block extra_js %}
    <!-- Shared filter functionality -->
    <script src="{% static 'js/shared_filters.js' %}"></script>
    
    <!-- Loading indicator management -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading indicator initially
            const loadingIndicator = document.getElementById('loadingIndicator');
            const mainContent = document.getElementById('mainContent');
            
            if (loadingIndicator && mainContent) {
                loadingIndicator.style.display = 'block';
                mainContent.style.display = 'none';
                
                // Hide loading indicator and show content after a short delay
                // This gives the impression that data is being processed
                setTimeout(function() {
                    loadingIndicator.style.display = 'none';
                    mainContent.style.display = 'block';
                }, 500);
            }
        });
    </script>
    {% endblock %}
{% endif %}
{% endblock %}
