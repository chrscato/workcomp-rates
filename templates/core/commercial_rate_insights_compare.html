{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ state_name }} Comparison - WorkComp Rates{% endblock %}

{% block extra_head %}
<!-- jQuery (required for Select2) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- Select2 for enhanced dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- Plotly for data visualization -->
<script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
<!-- Shared filter styles -->
<link rel="stylesheet" href="{% static 'css/shared_filters.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    {% if has_data %}
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">{{ state_name }} Rate Comparison</h4>
                            <p class="text-muted mb-0">Compare organizations and payers side by side</p>
                        </div>
                        <div>
                            <a href="{% url 'commercial_rate_insights_state' state_code %}" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-arrow-left"></i> Back to State Insights
                            </a>
                            <a href="{% url 'commercial_rate_insights_map' %}" class="btn btn-outline-primary">
                                <i class="fas fa-map"></i> Back to Map
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shared Filters Template -->
        {% include 'core/shared_filters.html' %}

        <!-- Base State Statistics -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">{{ state_name }} Base Statistics</h5>
                        <p class="text-muted mb-0">Overall state statistics with current filters</p>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Professional Rates -->
                            <div class="col-md-6">
                                <h6 class="text-primary">Professional Rates</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <p class="mb-1"><strong>Avg Rate:</strong></p>
                                        <p class="text-muted">${{ base_stats.professional.avg_rate|floatformat:0|intcomma }}</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="mb-1"><strong>Records:</strong></p>
                                        <p class="text-muted">{{ base_stats.professional.record_count|intcomma }}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <p class="mb-1"><strong>GA WCFS PROF:</strong></p>
                                        <p class="text-muted h5">{{ base_stats.professional.ga_prof_pct|floatformat:1 }}% of GA</p>
                                        <p class="text-muted small">${{ base_stats.professional.ga_prof_mar|floatformat:2|intcomma }}</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="mb-1"><strong>Medicare:</strong></p>
                                        <p class="text-muted h5">{{ base_stats.professional.medicare_prof_pct|floatformat:1 }}% of Medicare</p>
                                        <p class="text-muted small">${{ base_stats.professional.medicare_prof_mar|floatformat:2|intcomma }}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Facility Rates -->
                            <div class="col-md-6">
                                <h6 class="text-info">Facility Rates</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <p class="mb-1"><strong>Avg Rate:</strong></p>
                                        <p class="text-muted">${{ base_stats.facility.avg_rate|floatformat:0|intcomma }}</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="mb-1"><strong>Records:</strong></p>
                                        <p class="text-muted">{{ base_stats.facility.record_count|intcomma }}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <p class="mb-1"><strong>GA WCFS OP MAR:</strong></p>
                                        <p class="text-muted h5">{{ base_stats.facility.ga_op_pct|floatformat:1 }}% of GA OP</p>
                                        <p class="text-muted small">${{ base_stats.facility.ga_op_mar|floatformat:2|intcomma }}</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="mb-1"><strong>GA WCFS ASC MAR:</strong></p>
                                        <p class="text-muted h5">{{ base_stats.facility.ga_asc_pct|floatformat:1 }}% of GA ASC</p>
                                        <p class="text-muted small">${{ base_stats.facility.ga_asc_mar|floatformat:2|intcomma }}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <p class="mb-1"><strong>MEDICARE OP MAR:</strong></p>
                                        <p class="text-muted h5">{{ base_stats.facility.medicare_op_pct|floatformat:1 }}% of Medicare OP</p>
                                        <p class="text-muted small">${{ base_stats.facility.medicare_op_mar_stateavg|floatformat:2|intcomma }}</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="mb-1"><strong>MEDICARE ASC MAR:</strong></p>
                                        <p class="text-muted h5">{{ base_stats.facility.medicare_asc_pct|floatformat:1 }}% of Medicare ASC</p>
                                        <p class="text-muted small">${{ base_stats.facility.medicare_asc_mar_stateavg|floatformat:2|intcomma }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Selection -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Select Entities to Compare</h5>
                        <p class="text-muted mb-0">Choose up to 4 organizations and/or payers to compare side by side</p>
                    </div>
                    <div class="card-body comparison-selection">
                        <form method="get" id="compareForm">
                            <!-- Preserve existing filters -->
                            <input type="hidden" name="payer" value="{{ active_filters.payer|default:'' }}">
                            <input type="hidden" name="org_name" value="{{ active_filters.org_name|default:'' }}">
                            <input type="hidden" name="procedure_set" value="{{ active_filters.procedure_set|default:'' }}">
                            <input type="hidden" name="procedure_class" value="{{ active_filters.procedure_class|default:'' }}">
                            <input type="hidden" name="procedure_group" value="{{ active_filters.procedure_group|default:'' }}">
                            <input type="hidden" name="cbsa" value="{{ active_filters.cbsa|default:'' }}">
                            <input type="hidden" name="billing_code" value="{{ active_filters.billing_code|default:'' }}">
                            <input type="hidden" name="tin_value" value="{{ active_filters.tin_value|default:'' }}">
                            <input type="hidden" name="primary_taxonomy_code" value="{{ active_filters.primary_taxonomy_code|default:'' }}">
                            <input type="hidden" name="primary_taxonomy_desc" value="{{ active_filters.primary_taxonomy_desc|default:'' }}">
                            
                            <!-- Organization Selection -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="compare_orgs" class="form-label fw-bold">
                                        <i class="fas fa-hospital text-success"></i> Organizations to Compare
                                    </label>
                                    <select class="form-select filter-select select2-dropdown" id="compare_orgs" name="compare_orgs" multiple>
                                        {% for org in filters.organizations %}
                                            <option value="{{ org }}" {% if org in compare_orgs_selected %}selected{% endif %}>{{ org }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">Select up to 4 organizations to compare</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="compare_payers" class="form-label fw-bold">
                                        <i class="fas fa-building text-info"></i> Payers to Compare
                                    </label>
                                    <select class="form-select filter-select select2-dropdown" id="compare_payers" name="compare_payers" multiple>
                                        {% for payer in filters.payers %}
                                            <option value="{{ payer }}" {% if payer in compare_payers_selected %}selected{% endif %}>{{ payer }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">Select up to 4 payers to compare</small>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-chart-bar"></i> Compare Selected
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearCompareSelections()">
                                        <i class="fas fa-times"></i> Clear All
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Results -->
        {% if comparison_data %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Comparison Results</h5>
                        <p class="text-muted mb-0">Side-by-side comparison of selected entities</p>
                    </div>
                    <div class="card-body">
                        <div class="comparison-grid">
                            {% for entity in comparison_data %}
                            <div class="comparison-card">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">{{ entity.name }}</h5>
                                    <span class="badge bg-{% if entity.type == 'organization' %}primary{% else %}info{% endif %}">
                                        {{ entity.type|title }}
                                    </span>
                                </div>
                                
                                <!-- Professional Stats -->
                                <div class="mb-3">
                                    <h6 class="text-primary">Professional Rates</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <p class="mb-1"><strong>Avg Rate:</strong></p>
                                            <p class="text-muted">${{ entity.stats.professional.avg_rate|floatformat:0|intcomma }}</p>
                                        </div>
                                        <div class="col-6">
                                            <p class="mb-1"><strong>Records:</strong></p>
                                            <p class="text-muted">{{ entity.stats.professional.record_count|intcomma }}</p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <p class="mb-1"><strong>GA WCFS PROF:</strong></p>
                                            <p class="text-muted h5">{{ entity.stats.professional.ga_prof_pct|floatformat:1 }}% of GA</p>
                                            <p class="text-muted small">${{ entity.stats.professional.ga_prof_mar|floatformat:2|intcomma }}</p>
                                        </div>
                                        <div class="col-6">
                                            <p class="mb-1"><strong>Medicare:</strong></p>
                                            <p class="text-muted h5">{{ entity.stats.professional.medicare_prof_pct|floatformat:1 }}% of Medicare</p>
                                            <p class="text-muted small">${{ entity.stats.professional.medicare_prof_mar|floatformat:2|intcomma }}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Facility Stats -->
                                <div class="mb-3">
                                    <h6 class="text-info">Facility Rates</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <p class="mb-1"><strong>Avg Rate:</strong></p>
                                            <p class="text-muted">${{ entity.stats.facility.avg_rate|floatformat:0|intcomma }}</p>
                                        </div>
                                        <div class="col-6">
                                            <p class="mb-1"><strong>Records:</strong></p>
                                            <p class="text-muted">{{ entity.stats.facility.record_count|intcomma }}</p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <p class="mb-1"><strong>GA WCFS OP MAR:</strong></p>
                                            <p class="text-muted h5">{{ entity.stats.facility.ga_op_pct|floatformat:1 }}% of GA OP</p>
                                            <p class="text-muted small">${{ entity.stats.facility.ga_op_mar|floatformat:2|intcomma }}</p>
                                        </div>
                                        <div class="col-6">
                                            <p class="mb-1"><strong>GA WCFS ASC MAR:</strong></p>
                                            <p class="text-muted h5">{{ entity.stats.facility.ga_asc_pct|floatformat:1 }}% of GA ASC</p>
                                            <p class="text-muted small">${{ entity.stats.facility.ga_asc_mar|floatformat:2|intcomma }}</p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <p class="mb-1"><strong>MEDICARE OP MAR:</strong></p>
                                            <p class="text-muted h5">{{ entity.stats.facility.medicare_op_pct|floatformat:1 }}% of Medicare OP</p>
                                            <p class="text-muted small">${{ entity.stats.facility.medicare_op_mar_stateavg|floatformat:2|intcomma }}</p>
                                        </div>
                                        <div class="col-6">
                                            <p class="mb-1"><strong>MEDICARE ASC MAR:</strong></p>
                                            <p class="text-muted h5">{{ entity.stats.facility.medicare_asc_pct|floatformat:1 }}% of Medicare ASC</p>
                                            <p class="text-muted small">${{ entity.stats.facility.medicare_asc_mar_stateavg|floatformat:2|intcomma }}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Sample Records -->
                                {% if entity.sample_records %}
                                <div>
                                    <h6 class="text-secondary">Sample Records</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Code</th>
                                                    <th>TIN #</th>
                                                    <th>Taxonomy</th>
                                                    <th>Rate</th>
                                                    <th>GA Prof</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for record in entity.sample_records %}
                                                <tr>
                                                    <td>{{ record.billing_code }}</td>
                                                    <td>{{ record.tin_value }}</td>
                                                    <td>{{ record.primary_taxonomy_code }}</td>
                                                    <td>${{ record.rate|floatformat:2|intcomma }}</td>
                                                    <td>${{ record.ga_prof_mar|floatformat:2|intcomma|default:"-" }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- No Comparison Data -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="text-muted mb-3">
                            <i class="fas fa-chart-bar"></i>
                            No Comparison Data
                        </h5>
                        <p class="text-muted mb-4">
                            Select organizations and/or payers above to see comparison results.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

    {% else %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="text-warning mb-3">
                            <i class="fas fa-exclamation-triangle"></i>
                            {{ error_message }}
                        </h3>
                        <p class="text-muted mb-4">
                            The data for {{ state_name }} ({{ state_code }}) is not currently available.
                        </p>
                        <a href="{% url 'commercial_rate_insights_map' %}" class="btn btn-primary">
                            <i class="fas fa-map"></i> Back to State Map
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

{% if has_data %}
    {% block extra_js %}
    <!-- Shared filter functionality -->
    <script src="{% static 'js/shared_filters.js' %}"></script>
    <style>
        .filter-loading {
            opacity: 0.5;
            pointer-events: none;
        }
        .filter-error {
            border-color: red;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        .comparison-card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1.5rem;
            background-color: #fff;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .comparison-card h5 {
            color: #495057;
            font-size: 1.1rem;
        }
        .comparison-card h6 {
            font-size: 0.9rem;
            font-weight: 600;
        }
        .comparison-card .table-sm th,
        .comparison-card .table-sm td {
            padding: 0.25rem;
            font-size: 0.875rem;
        }
        
        /* Analytics Dashboard Filter Styles */
        .filter-tier {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            margin-bottom: 0.5rem;
        }
        
        .filter-tier:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        .filter-tier-title {
            color: #495057;
            font-weight: 600;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #007bff;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.85rem;
        }
        
        .filter-tier-title i {
            font-size: 0.9rem;
        }
        
        .form-label {
            color: #495057;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        
        .form-label i {
            margin-right: 0.25rem;
            width: 12px;
            font-size: 0.75rem;
        }
        
        .form-select {
            border-radius: 6px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            height: 32px;
        }
        
        .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.1rem rgba(0,123,255,0.25);
        }
        
        .filter-actions {
            text-align: center;
            padding: 0.75rem;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border-radius: 8px;
            margin-top: 0.5rem;
        }
        
        .filter-actions .btn {
            margin: 0 0.25rem;
            border-radius: 6px;
            font-weight: 600;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }
        
        .filter-actions .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .filter-actions .btn i {
            margin-right: 0.25rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .filter-tier {
                padding: 1rem;
            }
            
            .filter-actions .btn {
                display: block;
                width: 100%;
                margin: 0.5rem 0;
            }
        }
        
        /* Select2 customization */
        .select2-container--default .select2-selection--single {
            border-radius: 6px;
            border: 1px solid #e9ecef;
            height: 32px;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 30px;
            padding-left: 8px;
            font-size: 0.8rem;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 30px;
        }
        
        .select2-dropdown {
            border-radius: 6px;
            border: 1px solid #007bff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        /* Collapsible filter styles */
        .card-header[onclick] {
            transition: background-color 0.3s ease;
            padding: 0.75rem 1rem;
        }
        
        .card-header[onclick]:hover {
            background-color: #f8f9fa;
        }
        
        .card-header[onclick] .text-muted {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        #filterToggleIcon {
            transition: transform 0.3s ease;
            font-size: 0.9rem;
        }
        
        #filterCardBody {
            transition: all 0.3s ease;
            padding: 1rem;
        }
        
        /* Compact filter card when collapsed */
        .card-header[onclick] + .card-body[style*="display: none"] {
            padding: 0;
            margin: 0;
        }
        
        /* Active filters summary styles */
        .active-filters-summary .alert {
            border-radius: 8px;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .active-filters-summary .btn {
            border-radius: 6px;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        
        /* Comparison section styles */
        .comparison-selection {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #dee2e6;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        
        .comparison-selection .form-label {
            color: #495057;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .comparison-selection .form-label i {
            margin-right: 0.5rem;
            width: 16px;
            font-size: 0.9rem;
        }
        
        .comparison-selection .text-muted {
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        
        .comparison-selection .btn {
            border-radius: 6px;
            font-weight: 600;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .comparison-selection .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .comparison-selection .btn i {
            margin-right: 0.5rem;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Select2 for all filter dropdowns with multi-select support
            $('.select2-dropdown').select2({
                placeholder: 'Select one or more options...',
                allowClear: true,
                width: '100%',
                minimumInputLength: 0,
                closeOnSelect: false,
                templateResult: function(data) {
                    if (data.loading) return data.text;
                    if (!data.id) return data.text;
                    return $('<span>' + data.text + '</span>');
                },
                templateSelection: function(data) {
                    if (!data.id) return data.text;
                    return data.text;
                }
            });
            
            // Filter Logic
            const filterForm = document.getElementById('filterForm');
            const filterSelects = document.querySelectorAll('.filter-select');
            
            // Function to submit form
            function submitForm() {
                const formData = new FormData(filterForm);
                const params = new URLSearchParams(formData);
                window.location.href = `${window.location.pathname}?${params.toString()}`;
            }

            // Add change event listeners to all filters
            filterSelects.forEach(select => {
                select.addEventListener('change', () => {
                    submitForm();  // Submit form immediately on any filter change
                });
            });

            // Handle Select2 change events for filters (not comparison dropdowns)
            $('.filter-select.select2-dropdown').on('select2:select select2:unselect', function() {
                submitForm();
            });

            // Comparison Logic
            const compareOrgsSelect = document.getElementById('compare_orgs');
            const comparePayersSelect = document.getElementById('compare_payers');
            const maxSelections = 4;

            function updateComparisonSelections() {
                const selectedOrgs = $(compareOrgsSelect).val() || [];
                const selectedPayers = $(comparePayersSelect).val() || [];
                const totalSelected = selectedOrgs.length + selectedPayers.length;
                
                // Update the clear button state
                const clearButton = document.querySelector('button[onclick="clearCompareSelections()"]');
                if (clearButton) {
                    clearButton.disabled = totalSelected === 0;
                }
            }

            // Add event listeners to comparison dropdowns
            $(compareOrgsSelect).on('select2:select select2:unselect', function() {
                updateComparisonSelections();
            });
            
            $(comparePayersSelect).on('select2:select select2:unselect', function() {
                updateComparisonSelections();
            });

            // Initialize comparison selections
            updateComparisonSelections();

            // Handle comparison form submission
            const compareForm = document.getElementById('compareForm');
            if (compareForm) {
                compareForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const selectedOrgs = $(compareOrgsSelect).val() || [];
                    const selectedPayers = $(comparePayersSelect).val() || [];
                    
                    if (selectedOrgs.length === 0 && selectedPayers.length === 0) {
                        alert('Please select at least one organization or payer to compare.');
                        return;
                    }
                    
                    // Build URL with current filters and comparison selections
                    const currentUrl = new URL(window.location);
                    const params = new URLSearchParams(currentUrl.search);
                    
                    // Clear previous comparison selections
                    params.delete('compare_orgs');
                    params.delete('compare_payers');
                    
                    // Add new comparison selections
                    selectedOrgs.forEach(org => params.append('compare_orgs', org));
                    selectedPayers.forEach(payer => params.append('compare_payers', payer));
                    
                    // Navigate to the new URL
                    window.location.href = `${currentUrl.pathname}?${params.toString()}`;
                });
            }

            // Clear compare selections function
            window.clearCompareSelections = function() {
                $(compareOrgsSelect).val(null).trigger('change');
                $(comparePayersSelect).val(null).trigger('change');
                updateComparisonSelections();
            };

            // Initialize active filters display
            updateActiveFiltersDisplay();
            
            // Only collapse filters on first load (no active filters)
            const urlParams = new URLSearchParams(window.location.search);
            const hasActiveFilters = Array.from(urlParams.values()).some(value => value && value !== '');
            
            if (!hasActiveFilters) {
                // First load - keep collapsed
                document.getElementById('filterCardBody').style.display = 'none';
                document.getElementById('filterToggleIcon').className = 'fas fa-chevron-right';
            } else {
                // User has applied filters - expand and show
                document.getElementById('filterCardBody').style.display = 'block';
                document.getElementById('filterToggleIcon').className = 'fas fa-chevron-down';
            }
        });

        // Global functions for collapsible filters and active filters
        function toggleFilters() {
            const filterCardBody = document.getElementById('filterCardBody');
            const filterToggleIcon = document.getElementById('filterToggleIcon');
            
            if (filterCardBody.style.display === 'none') {
                filterCardBody.style.display = 'block';
                filterToggleIcon.className = 'fas fa-chevron-down';
            } else {
                filterCardBody.style.display = 'none';
                filterToggleIcon.className = 'fas fa-chevron-right';
            }
        }

        function updateActiveFiltersDisplay() {
            const activeFiltersSummary = document.getElementById('activeFiltersSummary');
            const activeFiltersText = document.getElementById('activeFiltersText');
            const filterSelects = document.querySelectorAll('.filter-select');
            
            const activeFilters = [];
            
            filterSelects.forEach(select => {
                if (select.value && select.value !== '') {
                    const filterName = select.getAttribute('data-filter') || select.name;
                    const filterValue = select.value;
                    
                    // Handle both single values and arrays
                    if (Array.isArray(filterValue) && filterValue.length > 0) {
                        activeFilters.push(`${filterName}: ${filterValue.join(', ')}`);
                    } else if (typeof filterValue === 'string' && filterValue.trim() !== '') {
                        activeFilters.push(`${filterName}: ${filterValue}`);
                    }
                }
            });
            
            if (activeFilters.length > 0) {
                activeFiltersText.textContent = activeFilters.join(', ');
                activeFiltersSummary.style.display = 'block';
            } else {
                activeFiltersText.textContent = 'No filters applied';
                activeFiltersSummary.style.display = 'none';
            }
        }

        function clearAllFilters() {
            const filterSelects = document.querySelectorAll('.filter-select');
            
            filterSelects.forEach(select => {
                select.value = '';
                if ($(select).hasClass('select2-hidden-accessible')) {
                    $(select).val('').trigger('change');
                }
            });
            
            // Submit the form to clear filters
            const filterForm = document.getElementById('filterForm');
            const formData = new FormData(filterForm);
            const params = new URLSearchParams(formData);
            window.location.href = `${window.location.pathname}?${params.toString()}`;
        }
    </script>
    {% endblock %}
{% endif %}
{% endblock %}
